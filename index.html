<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SOEPD Repair and Rehabilitation Status</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --brand: #2c3e50;
      --brand-2: #34495e;
      --accent: #2980b9;
      --bg: #f4f6f9;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background:var(--bg);
      color:#222;
    }
    header{
      background:var(--brand);
      color:#fff;
      padding:12px 16px;
      text-align:center;
      font-weight:700;
      letter-spacing:1px;
      font-size:24px;
    }
    .container{
      padding:12px 16px 20px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .filter-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin-bottom:4px;
    }
    .filters-left{
      display:flex;
      gap:12px;
      align-items:center;
    }
    label{font-size:14px}
    select, input[type="text"], input[type="number"], input[type="date"]{
      padding:6px 8px;
      border-radius:6px;
      border:1px solid #ccc;
      font-size:14px;
    }
    #toggleAddForm{
      padding:8px 12px;
      border-radius:6px;
      border:none;
      background:var(--accent);
      color:#fff;
      font-weight:700;
      cursor:pointer;
    }
    #toggleAddForm:hover{ background:#1f6391 }
    .chart-section {
      background: #fff;
      border: 1px solid #e6e6e6;
      border-radius: 12px;
      padding: 10px 14px;
      position: relative;
      overflow: hidden;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      height: 180px;
    }
    .table-section {
      background: #fff;
      border: 1px solid #e6e6e6;
      border-radius: 12px;
      overflow-y: auto;
      padding: 0;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      height: 340px;
    }
    table{
      width:100%;
      border-collapse:collapse;
    }
    thead th{
      position:sticky;
      top:0;
      background:var(--brand-2);
      color:#fff;
      padding:10px;
      font-size:13px;
      text-align:center;
      z-index:2;
    }
    tbody td{
      padding:10px;
      border-bottom:1px solid #eee;
      font-size:14px;
      text-align:center;
      vertical-align:middle;
    }
    tbody tr:hover{ background:#fbfdff }
    a.project-link{ color:var(--accent); text-decoration:none; font-weight:600 }
    a.project-link:hover{text-decoration:underline}
    .status-badge{
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      font-size:13px;
      font-weight:700;
      color:#fff;
    }
    .status-ongoing{ background:#27ae60 }
    .status-completed{ background:#2980b9 }
    .status-procurement{ background:#f39c12 } 
    .green{ background: #2ecc71; color:#fff; }
    .lightgreen{ background: #9fe6a8; color:#000; }
    .gold{ background:#f1c40f; color:#000; }
    .orange{ background:#f39c12; color:#000; }
    .red{ background:#e74c3c; color:#fff; }
    .neutral{ background:#bdc3c7; color:#fff; }
    #addProjectFormContainer{
      overflow:hidden;
      max-height:0;
      opacity:0;
      transition: max-height 0.35s ease, opacity 0.35s ease;
      background:#fff;
      border:1px solid #e6e6e6;
      border-radius:10px;
      padding:10px;
    }
    #addProjectFormContainer.open{
      max-height:720px;
      opacity:1;
    }
    #addProjectForm{
      display:grid;
      grid-template-columns:repeat(auto-fill, minmax(190px,1fr));
      gap:8px;
      align-items:center;
    }
    #addProjectForm input, #addProjectForm select{
      width:100%;
      padding:6px 8px;
      font-size:13px;
      border-radius:6px;
      border:1px solid #ccc;
    }
    #addProjectForm button[type="submit"]{
      grid-column:1 / -1;
      padding:8px 12px;
      background:var(--accent);
      color:#fff;
      border:none;
      border-radius:6px;
      font-weight:700;
      cursor:pointer;
    }
    #successMessage{
      display:none;
      margin-top:8px;
      background:#e9f8ef;
      border:1px solid #bfe6c6;
      color:#1d6f3a;
      padding:10px 12px;
      border-radius:8px;
      position:relative;
      font-weight:600;
    }
    #successMessage.show{ display:block; }
    #successMessage button{
      position:absolute;
      right:8px;
      top:8px;
      border:none;
      background:transparent;
      font-size:18px;
      cursor:pointer;
      color:#1d6f3a;
    }
    @media (max-width:640px){
      .filters-left{ flex-direction:column; align-items:flex-start; gap:8px }
      #addProjectForm{ grid-template-columns:1fr }
    }
  </style>
</head>
<body>
  <header>SOEPD Repair and Rehabilitation Status</header>

  <div class="container">
    <div class="filter-row">
      <div class="filters-left">
        <label for="categoryFilter">Project Category</label>
        <select id="categoryFilter">
          <option value="All">All</option>
          <option value="MOIST">MOIST</option>
          <option value="MOSES">MOSES</option>
        </select>

        <label for="statusFilter">Status</label>
        <select id="statusFilter">
          <option value="All">All</option>
          <option value="Ongoing">Ongoing</option>
          <option value="Completed">Completed</option>
          <option value="Procurement">Procurement</option>
        </select>

        <label for="yearFilter">Project Year</label>
        <select id="yearFilter">
          <option value="All">All</option>
          <option value="2023">2023</option>
          <option value="2024">2024</option>
          <option value="2025">2025</option>
        </select>
      </div>
      <button id="toggleAddForm">+ Add Project</button>
    </div>

    <div id="addProjectFormContainer" aria-hidden="true">
      <form id="addProjectForm">
        <input type="text" id="pr" placeholder="PURCHASE REQUEST #" required />
        <input type="text" id="category" placeholder="Category (MOIST / MOSES)" required />
        <input type="text" id="title" placeholder="Project Title" required />
        <input type="text" id="cost" placeholder="Project Cost (₱)" required />
        <select id="status">
          <option value="Ongoing">Ongoing</option>
          <option value="Completed">Completed</option>
          <option value="Procurement">Procurement</option>
        </select>
        <input type="number" id="completion" placeholder="Completion (%)" min="0" max="100" />
        <input type="date" id="start" />
        <input type="date" id="end" />
        <input type="date" id="actualStart" />
        <input type="date" id="actualEnd" />
        <button type="submit">Save Project</button>
      </form>

      <div id="successMessage" role="status" aria-live="polite">
        ✅ Project added successfully!
        <button id="closeMessage" aria-label="Close message">&times;</button>
      </div>
    </div>

    <div class="chart-section">
      <canvas id="completionChart" aria-label="Project completion chart"></canvas>
    </div>

    <div class="table-section" id="tableSection">
      <table>
        <thead>
          <tr>
            <th>PURCHASE REQUEST #</th>
            <th>PROJECT CATEGORY</th>
            <th>PROJECT TITLE</th>
            <th>PROJECT COST</th>
            <th>STATUS</th>
            <th>PROJECT COMPLETION (%)</th>
            <th>PROJECT CONTRACT DURATION</th>
            <th>START DATE</th>
            <th>END DATE</th>
            <th>ACTUAL START DATE</th>
            <th>ACTUAL END DATE</th>
            <th>REMAINING DAYS</th>
          </tr>
        </thead>
        <tbody id="projects-body"></tbody>
      </table>
    </div>
  </div>

  <script>
    const projects = [
      { pr: "520230904765", category: "MOSES", title: "Repair & Rehabilitation - Bislig City Seismic Station", cost: "1808000", status: "Ongoing", completion: 72, start: "2025-07-28", end: "2025-11-25", actualStart: "2025-09-08", actualEnd: "" },
      { pr: "-", category: "MOSES", title: "Repair & Rehabilitation - General Santos City Seismic Station", cost: "1800000", status: "Procurement", completion: 0, start: "", end: "", actualStart: "", actualEnd: "" },
      { pr: "520240904993-0-2", category: "MOSES", title: "Repair & Rehabilitation - Baguio City Seismic Station", cost: "3500000", status: "Procurement", completion: 0, start: "", end: "", actualStart: "", actualEnd: "" },
      { pr: "520240905003-0-1", category: "MOSES", title: "Repair & Rehabilitation - Surigao City Seismic Station", cost: "1500000", status: "Procurement", completion: 0, start: "", end: "", actualStart: "", actualEnd: "" },
      { pr: "520240905011", category: "MOSES", title: "Repair & Rehabilitation - Zamboanga City Seismic Station", cost: "750000", status: "Procurement", completion: 0, start: "", end: "", actualStart: "", actualEnd: "" },
      { pr: "520230804619", category: "MOIST", title: "Rehabilitation of Dapa Surigao del Norte SLMS", cost: "3848858", status: "Completed", completion: 100, start: "2022-05-05", end: "2024-12-15", actualStart: "2022-05-10", actualEnd: "2024-12-12" },
      { pr: "520240905167-0-1", category: "MOIST", title: "Establishment of SLMS - Moro Gulf", cost: "4800000", status: "Procurement", completion: 0, start: "", end: "", actualStart: "", actualEnd: "" },
      { pr: "520240905033-0-1", category: "MOIST", title: "Rehabilitation of SLMS - Guiuan, Eastern Samar", cost: "5000000", status: "Procurement", completion: 0, start: "", end: "", actualStart: "", actualEnd: "" }
    ];

    const toDate = s => s ? new Date(s + "T00:00:00") : null;
    const fmt = s => s || "-";
    const daysBetween = (a,b) => Math.round((b - a) / 86400000);
    const projectDurationDays = p => (toDate(p.start) && toDate(p.end)) ? `${daysBetween(toDate(p.start), toDate(p.end))} days` : "-";
    const remainingDays = p => {
      if (!p) return "-";
      if (p.status && p.status.toLowerCase() === "completed") return 0;
      if (p.actualEnd) return 0;
      const e = toDate(p.end);
      if (!e) return "-";
      const today = new Date();
      return Math.ceil((e - today) / 86400000);
    };

    function colorizeRemainingDays(p){
      if(p.status && p.status.toLowerCase()==="procurement" && !p.start && !p.end){
        return `<td class="neutral">Not started</td>`;
      }
      const rem = remainingDays(p);
      const s = toDate(p.start), e = toDate(p.end);
      if (rem === "-" || !s || !e) return `<td>${rem}</td>`;
      const duration = daysBetween(s,e);
      if (duration <= 0) return `<td>-</td>`;
      if (rem < 0) return `<td class="red"><strong title="Overdue by ${Math.abs(rem)} days">Overdue</strong></td>`;
      const percent = Math.round((rem / duration) * 100);
      let cls = "green";
      if (rem <= duration * 0.25) cls = "orange";
      else if (rem <= duration * 0.50) cls = "gold";
      else if (rem <= duration * 0.75) cls = "lightgreen";
      return `<td class="${cls}" title="${percent}% of time left (${rem} days)"><strong>${rem}</strong></td>`;
    }

    const tbody = document.getElementById("projects-body");
    const categoryFilter = document.getElementById("categoryFilter");
    const statusFilter = document.getElementById("statusFilter");
    const yearFilter = document.getElementById("yearFilter");
    const toggleAddForm = document.getElementById("toggleAddForm");
    const addProjectFormContainer = document.getElementById("addProjectFormContainer");
    const addProjectForm = document.getElementById("addProjectForm");
    const successMessage = document.getElementById("successMessage");
    const closeMessage = document.getElementById("closeMessage");
    const costInput = document.getElementById("cost");

    const ctx = document.getElementById("completionChart").getContext("2d");
    const completionChart = new Chart(ctx, {
      type: "bar",
      data: {
        labels: projects.map(p => p.title),
        datasets: [{
          label: "Project Completion (%)",
          data: projects.map(p => p.completion),
          backgroundColor: "#4aa3df"
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins:{ legend:{ display:false } },
        scales:{
          y:{ beginAtZero:true, max:100, title:{ display:true, text:"Completion (%)" } },
          x:{ ticks:{
            autoSkip:true,
            maxRotation:45,
            minRotation:0,
            callback: function(val, index, ticks){
              const label = this.getLabelForValue(index) || "";
              return label.length > 18 ? label.substring(0,18) + "…" : label;
            }
          }}
        }
      }
    });

    function render(category="All", status="All", year="All"){
      tbody.innerHTML = "";
      let filtered = category === "All" ? projects : projects.filter(p => p.category === category);
      filtered = status === "All" ? filtered : filtered.filter(p => p.status === status);

      if(year !== "All"){
        filtered = filtered.filter(p => {
          if(!p.pr || p.pr.length < 5) return false;
          const prYear = p.pr.substring(1,5);
          return prYear === year;
        });
      }

      filtered.forEach(p => {
        const statusClass = (p.status && p.status.toLowerCase() === "completed") ? "status-completed" :
                            (p.status && p.status.toLowerCase() === "procurement") ? "status-procurement" : "status-ongoing";
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${p.pr}</td>
          <td>${p.category}</td>
          <td><a href="#" class="project-link" data-pr="${p.pr}">${p.title}</a></td>
          <td>₱${Number(p.cost || 0).toLocaleString()}</td>
          <td><span class="status-badge ${statusClass}">${p.status}</span></td>
          <td>${p.completion}%</td>
          <td>${projectDurationDays(p)}</td>
          <td>${fmt(p.start)}</td>
          <td>${fmt(p.end)}</td>
          <td>${fmt(p.actualStart)}</td>
          <td>${fmt(p.actualEnd)}</td>
          ${colorizeRemainingDays(p)}
        `;
        tbody.appendChild(tr);
      });

      completionChart.data.labels = filtered.map(p => p.title);
      completionChart.data.datasets[0].data = filtered.map(p => p.completion);
      completionChart.update();
    }

    toggleAddForm.addEventListener("click", () => {
      addProjectFormContainer.classList.toggle("open");
      const open = addProjectFormContainer.classList.contains("open");
      toggleAddForm.textContent = open ? "– Close Form" : "+ Add Project";
      addProjectFormContainer.setAttribute("aria-hidden", !open);
    });

    costInput.addEventListener("input", (e) => {
      let v = e.target.value.replace(/,/g, "").replace(/[^\d]/g, "");
      if (v === "") { e.target.value = ""; return; }
      e.target.value = Number(v).toLocaleString();
    });

    addProjectForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const rawCost = (document.getElementById("cost").value || "").replace(/,/g, "").trim() || "0";
      const newProject = {
        pr: document.getElementById("pr").value.trim(),
        category: document.getElementById("category").value.trim(),
        title: document.getElementById("title").value.trim(),
        cost: rawCost,
        status: document.getElementById("status").value,
        completion: parseInt(document.getElementById("completion").value || "0"),
        start: document.getElementById("start").value || "",
        end: document.getElementById("end").value || "",
        actualStart: document.getElementById("actualStart").value || "",
        actualEnd: document.getElementById("actualEnd").value || ""
      };
      projects.push(newProject);
      render(categoryFilter.value, statusFilter.value, yearFilter.value);
      addProjectForm.reset();
      addProjectFormContainer.classList.remove("open");
      toggleAddForm.textContent = "+ Add Project";
      addProjectFormContainer.setAttribute("aria-hidden", "true");
      successMessage.classList.add("show");
      successMessage.style.display = "block";
      setTimeout(() => {
        successMessage.classList.remove("show");
        successMessage.style.display = "none";
      }, 3000);
    });

    closeMessage.addEventListener("click", () => {
      successMessage.classList.remove("show");
      successMessage.style.display = "none";
    });

    categoryFilter.addEventListener("change", () => render(categoryFilter.value, statusFilter.value, yearFilter.value));
    statusFilter.addEventListener("change", () => render(categoryFilter.value, statusFilter.value, yearFilter.value));
    yearFilter.addEventListener("change", () => render(categoryFilter.value, statusFilter.value, yearFilter.value));

    document.addEventListener("click", (ev) => {
      const a = ev.target.closest && ev.target.closest(".project-link");
      if (!a) return;
      ev.preventDefault();
      const pr = a.dataset.pr;
      const project = projects.find(p => p.pr === pr);
      if (!project) return;
      generateProjectPage(project);
    });

    function generateProjectPage(project){
      const w = window.open("", "_blank");
      if (!w) return;
      const html = `
<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>${project.title}</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{ font-family:Segoe UI,Arial,Helvetica,sans-serif; padding:20px; background:#f6f8fa; color:#222 }
    .card{ background:#fff; padding:16px; border-radius:8px; box-shadow:0 1px 4px rgba(0,0,0,0.06) }
    h1{ color:#2c3e50; margin:0 0 12px 0 }
    table{ width:100%; border-collapse:collapse; margin-top:12px }
    th, td{ text-align:left; padding:8px; border-bottom:1px solid #eee }
    th{ width:220px; color:#666; }
  </style>
</head>
<body>
  <div class="card">
    <h1>${project.title}</h1>
    <table>
      <tr><th>PR #</th><td>${project.pr}</td></tr>
      <tr><th>Category</th><td>${project.category}</td></tr>
      <tr><th>Cost</th><td>₱${Number(project.cost || 0).toLocaleString()}</td></tr>
      <tr><th>Status</th><td>${project.status}</td></tr>
      <tr><th>Completion</th><td>${project.completion}%</td></tr>
      <tr><th>Start Date</th><td>${fmt(project.start)}</td></tr>
      <tr><th>End Date</th><td>${fmt(project.end)}</td></tr>
      <tr><th>Actual Start</th><td>${fmt(project.actualStart)}</td></tr>
      <tr><th>Actual End</th><td>${fmt(project.actualEnd)}</td></tr>
      <tr><th>Remaining Days</th><td>${remainingDays(project)}</td></tr>
    </table>
  </div>
</body>
</html>
`;
      w.document.write(html);
      w.document.close();
    }

    render("All","All","All");
  </script>
</body>
</html>
